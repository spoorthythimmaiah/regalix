!function (e) {
    e.fn.sortableLists = function (s) {
        function l(s, l, r) {
            X.isDragged = !0;
            var i = parseInt(l.css("margin-top")), n = parseInt(l.css("margin-bottom")),
                a = parseInt(l.css("margin-left")), c = parseInt(l.css("margin-right")), d = l.offset(),
                p = l.innerHeight();
            X.rootEl = {el: r, offset: r.offset(), rootElClass: r.attr("class")}, X.cEl = {
                el: l,
                mT: i,
                mL: a,
                mB: n,
                mR: c,
                offset: d
            }, X.cEl.xyOffsetDiff = {
                X: s.pageX - X.cEl.offset.left,
                Y: s.pageY - X.cEl.offset.top
            }, X.cEl.el.addClass("sortableListsCurrent " + L.currElClass), l.before(w);
            var f = X.placeholderNode = e("#sortableListsPlaceholder");
            l.css({
                width: l.width(),
                position: "absolute",
                top: d.top - i,
                left: d.left - a
            }).prependTo(E), f.css({
                display: "block",
                height: p
            }), Y.css("height", p), X.doc.on("mousemove", o).on("mouseup", t)
        }

        function o(s) {
            if (X.isDragged) {
                var l = X.cEl, o = X.doc, t = X.win;
                s.pageX || a(s), o.scrollTop() > X.rootEl.offset.top - 10 && s.clientY < 50 ? X.upScroll ? (s.pageY = s.pageY - L.scroll, e("html, body").each(function (s) {
                    e(this).scrollTop(e(this).scrollTop() - L.scroll)
                }), n(s)) : r(s) : o.scrollTop() + t.height() < X.rootEl.offset.top + X.rootEl.el.outerHeight(!1) + 10 && t.height() - s.clientY < 50 ? X.downScroll ? (s.pageY = s.pageY + L.scroll, e("html, body").each(function (s) {
                    e(this).scrollTop(e(this).scrollTop() + L.scroll)
                }), n(s)) : i(s) : c(X), X.oElOld = X.oEl, l.el[0].style.visibility = "hidden", X.oEl = oEl = p(s.pageX, s.pageY), l.el[0].style.visibility = "visible", f(s, X), d(s, X)
            }
        }

        function t(s) {
            var l = X.cEl, r = e("#sortableListsHint", X.rootEl.el), i = Y[0].style, n = null, a = !1,
                d = e("#sortableListsHintWrapper");
            "block" == i.display && r.length && X.isAllowed ? (n = r, a = !0) : (n = X.placeholderNode, a = !1), offset = n.offset(), l.el.animate({
                left: offset.left - X.cEl.mL,
                top: offset.top - X.cEl.mT
            }, 250, function () {
                v(l), n.after(l.el[0]), n[0].style.display = "none", i.display = "none", r.remove(), d.removeAttr("id").removeClass(L.hintWrapperClass), d.length && d.prev("div").append(S.clone(!0)), a ? X.placeholderNode.slideUp(150, function () {
                    X.placeholderNode.remove(), b(), L.onChange(l.el), L.complete(l.el), X.isDragged = !1
                }) : (X.placeholderNode.remove(), b(), L.complete(l.el), X.isDragged = !1)
            }), c(X), X.doc.unbind("mousemove", o).unbind("mouseup", t)
        }

        function r(e) {
            X.upScroll || (X.upScroll = setInterval(function () {
                X.doc.trigger("mousemove")
            }, 50))
        }

        function i(e) {
            X.downScroll || (X.downScroll = setInterval(function () {
                X.doc.trigger("mousemove")
            }, 50))
        }

        function n(e) {
            X.pY = e.pageY, X.pX = e.pageX, X.cY = e.clientY, X.cX = e.clientX
        }

        function a(e) {
            e.pageY = X.pY, e.pageX = X.pX, e.clientY = X.cY, e.clientX = X.cX
        }

        function c(e) {
            clearInterval(e.upScroll), clearInterval(e.downScroll), e.upScroll = e.downScroll = !1
        }

        function d(e, s) {
            var l = s.cEl;
            l.el.css({top: e.pageY - l.xyOffsetDiff.Y - l.mT, left: e.pageX - l.xyOffsetDiff.X - l.mL})
        }

        function p(s, l) {
            if (!document.elementFromPoint) return null;
            var o = X.isRelEFP;
            if (null === o) {
                var t, r;
                (t = X.doc.scrollTop()) > 0 && (o = null == (r = document.elementFromPoint(0, t + e(window).height() - 1)) || "HTML" == r.tagName.toUpperCase()), (t = X.doc.scrollLeft()) > 0 && (o = null == (r = document.elementFromPoint(t + e(window).width() - 1, 0)) || "HTML" == r.tagName.toUpperCase())
            }
            o && (s -= X.doc.scrollLeft(), l -= X.doc.scrollTop());
            var i = e(document.elementFromPoint(s, l));
            return X.rootEl.el.find(i).length ? i.is("#sortableListsPlaceholder") || i.is("#sortableListsHint") ? null : i.is("li") ? i.is("li") ? i : void 0 : (i = i.closest("li"), i[0] ? i : null) : null
        }

        function f(e, s) {
            var l = s.oEl;
            if (l && s.oElOld) {
                var o = l.outerHeight(!1), t = e.pageY - l.offset().top;
                15 > t ? u(e, l) : t > o - 15 && h(e, l)
            }
        }

        function u(s, l) {

            var Z = L.insertZone;
            if( Y.parents("li").first().attr('data-item') == 'demo' ){
                Z = 999;
            }


            if (e("#sortableListsHintWrapper", X.rootEl.el).length && Y.unwrap(), s.pageX - l.offset().left < Z) {
                if (l.prev("#sortableListsPlaceholder").length) return void Y.css("display", "none");
                m(l);
                l.before(Y)

            } else {
                var o = l.children(), t = l.children("ul").first();
                if (t.children().first().is("#sortableListsPlaceholder")) return void Y.css("display", "none");
                t.length ? t.prepend(Y) : (o.first().after(Y), Y.wrap(T)), X.oEl && g(l)
            }


            Y.css("display", "block"), X.isAllowed = L.isAllowed(X.cEl.el, Y, Y.parents("li").first())

        }

        function h(s, l) {

            var Z = L.insertZone;
            if( Y.parents("li").first().attr('data-item') == 'demo' ){
                Z = 999;
            }

            if (e("#sortableListsHintWrapper", X.rootEl.el).length && Y.unwrap(), s.pageX - l.offset().left < Z) {
                if (l.next("#sortableListsPlaceholder").length) return void Y.css("display", "none");
                m(l);
                l.after(Y)
            } else {
                var o = l.children(), t = l.children(L.listSelector).last();
                if (t.children().last().is("#sortableListsPlaceholder")) return void Y.css("display", "none");
                t.length ? o.last().append(Y) : (l.append(Y), Y.wrap(T)), X.oEl && g(l)
            }


            Y.css("display", "block"), X.isAllowed = L.isAllowed(X.cEl.el, Y, Y.parents("li").first())

        }

        function g(e) {
            e.removeClass("sortableListsClosed").addClass("sortableListsOpen"), e.children("ul, ol").css("display", "block"), e.children("div").children(".sortableListsOpener").first().css("background-image", "url(" + L.opener.close + ")")
        }

        function m(e) {
            e.removeClass("sortableListsOpen").addClass("sortableListsClosed"), e.children("ul:not(.playlist), ol").css("display", "none"), e.children("div").children(".sortableListsOpener").first().css("background-image", "url(" + L.opener.open + ")")
        }

        function v(e) {
            var s = e.el[0].style;
            e.el.removeClass(L.currElClass + " sortableListsCurrent"), s.top = "0", s.left = "0", s.position = "relative", s.width = "auto"
        }

        function b() {
            e(L.listSelector, X.rootEl.el).each(function (s) {
                e(this).children().length
            })
        }

        var C = e("body").css("position", "relative"), y = {
                currElClass: "",
                placeholderClass: "",
                placeholderCss: {position: "relative", padding: 0},
                hintClass: "",
                hintCss: {display: "none", position: "relative", padding: 0},
                hintWrapperClass: "",
                hintWrapperCss: {},
                baseClass: "",
                baseCss: {
                    position: "absolute",
                    top: 0 - parseInt(C.css("margin-top")),
                    left: 0 - parseInt(C.css("margin-left")),
                    margin: 0,
                    padding: 0,
                    "z-index": 2500
                },
                opener: {
                    active: !1,
                    open: "",
                    close: "",
                    openerCss: {
                        "float": "left",
                        display: "inline-block",
                        "background-position": "center center",
                        "background-repeat": "no-repeat"
                    },
                    openerClass: ""
                },
                listSelector: "ul",
                listsClass: "",
                listsCss: {},
                insertZone: 50,
                scroll: 20,
                ignoreClass: "",
                isAllowed: function (e, s, l) {
                    return !0
                },
                onDragStart: function (e, s) {
                    return !0
                },
                onChange: function (e) {
                    return !0
                },
                complete: function (e) {
                    return !0
                }
            }, L = e.extend(!0, {}, y, s),
            E = e("<" + L.listSelector + " />").prependTo(C).attr("id", "sortableListsBase").css(L.baseCss).addClass(L.listsClass + " " + L.baseClass),
            w = e("<li />").attr("id", "sortableListsPlaceholder").css(L.placeholderCss).addClass(L.placeholderClass),
            Y = e("<li />").attr("id", "sortableListsHint").css(L.hintCss).addClass(L.hintClass),
            T = e("<" + L.listSelector + " />").attr("id", "sortableListsHintWrapper").addClass(L.listsClass + " " + L.hintWrapperClass).css(L.listsCss).css(L.hintWrapperCss),
            S = e("<span />").addClass("sortableListsOpener " + L.opener.openerClass).css("background-image", "url(" + L.opener.close + ")").css(L.opener.openerCss).on("mousedown", function (s) {
                var l = e(this).closest("li");
                return l.hasClass("sortableListsClosed") ? g(l) : m(l), !1
            }), X = {
                isDragged: !1,
                isRelEFP: null,
                oEl: null,
                rootEl: null,
                cEl: null,
                upScroll: !1,
                downScroll: !1,
                pX: 0,
                pY: 0,
                cX: 0,
                cY: 0,
                isAllowed: !0,
                e: {pageX: 0, pageY: 0, clientX: 0, clientY: 0},
                doc: e(document),
                win: e(window)
            };
        if (L.opener.active) {
            if (!L.opener.open) throw"Url for opener.open image is not defined";
            if (!L.opener.close) throw"Url for opener.close image is not defined";
            e(this).find("li:not([data-item=playlist],[data-item=demo])").each(function () {
                var s = e(this);
                s.children("ul,ol").length && (S.clone(!0).prependTo(s.children("div").first()), s.hasClass("sortableListsOpen") || (s.addClass("sortableListsClosed"), m(s)))
            })
        }
        return this.on("mousedown", function (s) {

            if(s.which == 3) return;

            var o = e(s.target);
            if (!(X.isDragged !== !1 || L.ignoreClass && o.hasClass(L.ignoreClass))) {
                s.preventDefault();
                var t = o.is("li") ? o : o.closest("li"), r = e(this);
                t[0] && (L.onDragStart(s, t), l(s, t, r))
            }
        })
    }, e.fn.sortableListsToArray = function (s, l) {
        s = s || [];
        var o = 0;
        return this.children("li").each(function () {
            var t = e(this), r = {}, i = t.attr("id");
            if (!i) throw console.log(t), "Previous item in console.log has no id. It is necessary to create the array.";
            r.id = i, r.parentId = l, r.value = t.data("value"), r.order = o, s.push(r), t.children("ul,ol").sortableListsToArray(s, i), o++
        }), s
    }, e.fn.sortableListsToHierarchy = function () {
        var s = [], l = 0;
        return e(this).children("li").each(function () {
            var o = e(this), t = {}, r = o.attr("id");
            if (!r) throw console.log(o), "Previous item in console.log has no id. It is necessary to create the array.";
            t.id = r, t.value = o.data("value"), t.order = l, s.push(t), t.children = o.children("ul,ol").sortableListsToHierarchy(), l++
        }), s
    }, e.fn.sortableListsToString = function (s, l) {
        return s = s || [], l = l || "no-parent", e(this).children("li").each(function () {
            var o = e(this), t = o.attr("id"), r = t ? t.match(/(.+)[-=_](.+)/) : null;
            if (!r) throw console.log(o), "Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string.";
            s.push(r[1] + "[" + r[2] + "]=" + l), e(this).children("ul,ol").sortableListsToString(s, r[2])
        }), s.join("&")
    }
}(jQuery);